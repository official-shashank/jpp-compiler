<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Code Playground</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #editorWrapper {
      position: relative;
      height: 70vh;
    }
    #codeEditor {
      white-space: pre-wrap;
      word-wrap: break-word;
      outline: none;
      font-family: monospace;
      caret-color: white;
      color: white;
      line-height: 1.5;
      height: 100%;
      overflow-y: auto;
      padding: 1rem;
      background: #1e293b;
      border-radius: 8px;
    }
    #suggestionBox {
      position: absolute;
      background: #1f2937;
      border: 1px solid #374151;
      border-radius: 4px;
      padding: 4px 0;
      z-index: 10;
      font-family: monospace;
      color: white;
      display: none;
      max-width: 300px;
    }
    .suggestion-item {
      padding: 4px 8px;
      cursor: pointer;
    }
    .suggestion-item:hover {
      background-color: #374151;
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans min-h-screen">
  <div class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="p-4 bg-gray-800 flex justify-between items-center">
      <h1 class="text-lg font-bold text-white">Code Playground</h1>
      <select id="languageSelector" class="bg-gray-700 text-white p-2 rounded">
        <option value="javascript">JavaScript</option>
        <option value="python">Python</option>
        <option value="matlang">MatLang</option>
      </select>
    </header>

    <!-- Main Content -->
    <div class="flex-1 p-4 flex flex-col md:flex-row gap-4">
      <!-- Editor -->
      <div id="editorWrapper" class="flex-1 bg-gray-800 relative rounded">
        <div 
          id="codeEditor" 
          class="w-full h-full bg-transparent overflow-auto resize-none" 
          contenteditable="true"></div>
        <div id="suggestionBox"></div>
      </div>

      <!-- Output -->
      <div class="w-full md:w-1/3 p-4 bg-gray-800 flex flex-col">
        <button 
          id="runCode" 
          class="bg-blue-600 text-white py-2 px-4 mb-4 rounded hover:bg-blue-700">
          Run Code
        </button>
        <button 
          id="downloadCode" 
          class="bg-green-600 text-white py-2 px-4 mb-4 rounded hover:bg-green-700">
          Download Code
        </button>
        <div id="output" class="bg-gray-900 text-white p-4 rounded h-full overflow-auto">
          Output will appear here.
        </div>
      </div>
    </div>
  </div>

  <!-- Include MatLangCompiler -->
  <script src="./js/language/mat-lang/compiler.js"></script>  <!-- Adjust the path to the actual file location -->

  <script>
    const editor = document.getElementById('codeEditor');
    const languageSelector = document.getElementById('languageSelector');
    const suggestionBox = document.getElementById('suggestionBox');
    const runCode = document.getElementById('runCode');
    const output = document.getElementById('output');
    const downloadCode = document.getElementById('downloadCode');

    const languageDefinitions = {
      javascript: ['function', 'return', 'const', 'let', 'var', 'if', 'else', 'for', 'while', 'console.log', 'class'],
      python: ['def', 'return', 'if', 'else', 'elif', 'for', 'while', 'import', 'print', 'class'],
      matlang: [
        'mana', 'badlo', 'jod', 'ghatao', 'guna', 'vibhajit', 'mod', 'swap',
        'dikhai', 'pucho', 'agar', 'jabtak', 'roko', 'aage_badho', 'samasya',
        'kaam', 'lauto', 'soochi', 'jod_suchi_mein', 'hatana', 'vigyaan',
        'barabar', 'bada', 'chhota', 'lambaai', 'kuch_bhi', 'khatam', 'naam'
      ]
    };

    let currentLanguage = languageSelector.value;

    // Compiler class to simulate execution
    class Compiler {
      execute(language, code) {
        try {
          if (language === 'javascript') {
            return this.executeJavaScript(code);
          } else if (language === 'python') {
            return 'Python execution is not yet supported.';
          } else if (language === 'matlang') {
            return this.executeMatLang(code);
          } else {
            throw new Error('Unsupported language.');
          }
        } catch (err) {
          return `Error: ${err.message}`;
        }
      }

      executeJavaScript(code) {
        const originalLog = console.log;
        let result = '';
        console.log = function (...args) {
          result += args.join(' ') + '\n';
        };
        eval(code); // Execute code
        console.log = originalLog; // Restore console.log
        return result || 'Execution completed.';
      }

      executeMatLang(code) {
        try {
          console.log(code);
          const compiler = new MatLangCompiler();  // Use the external MatLangCompiler
          const compiledCode = compiler.compile(code);// Convert to JS using MatLangCompiler

          console.log(compiledCode)
          return this.executeJavaScript(compiledCode); // Run JS code
        } catch (err) {
          return `MatLang Error: ${err.message}`;
        }
      }
    }

    const compiler = new Compiler();

    // Keyword suggestions
    const getCurrentWord = () => {
      const selection = window.getSelection();
      if (!selection.rangeCount) return '';
      const range = selection.getRangeAt(0);
      const text = range.startContainer.textContent || '';
      const cursorPosition = range.startOffset;
      const beforeCursor = text.slice(0, cursorPosition);
      const afterCursor = text.slice(cursorPosition);
      const wordStart = beforeCursor.lastIndexOf(' ') + 1;
      const wordEnd = afterCursor.indexOf(' ') === -1 ? afterCursor.length : afterCursor.indexOf(' ');
      return beforeCursor.slice(wordStart) + afterCursor.slice(0, wordEnd);
    };

    const showSuggestions = () => {
      const word = getCurrentWord().trim();
      if (!word) {
        suggestionBox.style.display = 'none';
        return;
      }

      const keywords = languageDefinitions[currentLanguage] || [];
      const suggestions = keywords.filter((kw) => kw.startsWith(word));
      if (suggestions.length > 0) {
        suggestionBox.innerHTML = suggestions
          .map((s) => `<div class="suggestion-item">${s}</div>`)
          .join('');
        suggestionBox.style.display = 'block';
        const range = window.getSelection().getRangeAt(0);
        const rect = range.getBoundingClientRect();
        suggestionBox.style.top = `${rect.bottom + window.scrollY}px`;
        suggestionBox.style.left = `${rect.left + window.scrollX}px`;
      } else {
        suggestionBox.style.display = 'none';
      }
    };

    editor.addEventListener('input', showSuggestions);

    // Apply suggestion on click
    suggestionBox.addEventListener('click', (e) => {
      if (e.target.classList.contains('suggestion-item')) {
        const suggestion = e.target.textContent;
        const selection = window.getSelection();
        const range = selection.getRangeAt(0);
        const textNode = range.startContainer;
        const cursorPosition = range.startOffset;
        const text = textNode.textContent;
        const wordStart = text.lastIndexOf(' ', cursorPosition - 1) + 1;
        const wordEnd = cursorPosition + suggestion.length;
        textNode.textContent = text.slice(0, wordStart) + suggestion + text.slice(wordEnd);
        selection.collapse(textNode, wordStart + suggestion.length);
        showSuggestions();
      }
    });

    // Run the code
    runCode.addEventListener('click', () => {
      const code = editor.textContent.trim();
      output.textContent = compiler.execute(currentLanguage, code);
    });

    // Download code as a file
    downloadCode.addEventListener('click', () => {
      const code = editor.textContent.trim();
      const blob = new Blob([code], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'code.txt';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // Language selector change handler
    languageSelector.addEventListener('change', (e) => {
      currentLanguage = e.target.value;
      suggestionBox.style.display = 'none'; // Hide suggestions when language changes
    });
  </script>
</body>
</html>
